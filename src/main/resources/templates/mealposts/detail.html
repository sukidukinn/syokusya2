<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<link rel="icon" type="image/x-icon" th:href="@{/favicon.ico}">
	<meta charset="UTF-8">
	<title>é£Ÿäº‹æŠ•ç¨¿è©³ç´°</title>
	<link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
</head>

<body>
	<form th:action="@{/mealPosts/save}" th:object="${mealPost}" method="post" enctype="multipart/form-data">
		<input type="hidden" th:field="*{id}">
		<div th:if="${pageMessage != null and !#strings.isEmpty(pageMessage)}" class="alert alert-info"
			th:text="${pageMessage}">
		</div>
		<div class="card mb-4">
			<div class="row g-0">
				<!-- å·¦å´ï¼šç”»åƒ -->
				<div class="col-md-6 p-3 border-end">
					<img th:if="${mealPost.photoPath != null}"
						th:src="@{'/uploads/' + ${#strings.substringAfter(mealPost.photoPath, 'uploads/')}}"
						class="img-fluid rounded-start mb-3" alt="meal photo">

					<span th:if="${mealPost.photoPath == null}">ç”»åƒãªã—</span>

					<div class="mb-3">
						<label>å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼š</label>
						<input type="file" name="photoFile" class="form-control" onchange="previewImage(event)">
					</div>

					<div class="mb-3" id="preview-container" style="display: none;">
						<label>é£Ÿäº‹å†™çœŸï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰<br><strong>â€»é£Ÿäº‹æƒ…å ±æ›´æ–°ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨åæ˜ ã•ã‚Œã¾ã™</strong></label><br>
						<img id="preview" class="img-thumbnail" width="360" height="240" style="display: none;" />
					</div>

					<!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
					<div class="mt-3 d-flex gap-3">
						<button type="submit" name="action" value="save" class="btn btn-primary">ä¿å­˜ã—ã¦æˆ»ã‚‹</button>
						<button type="submit" name="action" value="saveOnly" class="btn btn-secondary">ä¿å­˜ã®ã¿</button>

						<!-- ç”»åƒå‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆGETã§ç”»åƒã®ã¿ã‚¯ãƒªã‚¢ï¼‰ -->
						<a th:if="${mealPost.id != null}" th:href="@{/mealPosts/{id}/clearImage(id=${mealPost.id})}"
							class="btn btn-warning" onclick="return confirm('ç”»åƒã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ');">
							ç”»åƒã®ã¿å‰Šé™¤
						</a>

						<!-- æŠ•ç¨¿å‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆGETã§å‰Šé™¤ç¢ºèªä»˜ãï¼‰ -->
						<a th:if="${mealPost.id != null}" th:href="@{/mealPosts/delete/{id}(id=${mealPost.id})}"
							class="btn btn-danger" onclick="return confirm('ã“ã®é£Ÿäº‹æŠ•ç¨¿ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ');">
							é£Ÿäº‹å‰Šé™¤
						</a>
					</div>
				</div>

				<!-- å³å´ï¼šå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
				<div class="col-md-6 p-3">
					<div class="mb-2">
						<label>é£Ÿäº‹åï¼š</label>
						<input type="text" th:field="*{mealName}" class="form-control">
					</div>
					<div class="mb-2">
						<label>é£Ÿäº‹æ™‚é–“ï¼š</label>
						<input type="datetime-local" th:field="*{mealTime}" class="form-control" />
					</div>
					<div class="mb-2">
						<label>ãƒ¡ãƒ¢ï¼š</label>
						<textarea th:field="*{memo}" class="form-control" rows="2"></textarea>
					</div>
					<div class="mb-2">
						<label>ã‚«ãƒ­ãƒªãƒ¼ï¼š</label>
						<input type="number" th:field="*{totalCalorie}" step="0.01" class="form-control">
						<label>ç·é‡é‡ (g)ï¼š</label>
						<input type="number" th:field="*{totalGrams}" step="0.1" class="form-control">
					</div>
				</div>
				<div class="row">
					<div class="col">
						<label>ãŸã‚“ã±ãè³ªï¼š</label>
						<input type="number" th:field="*{proteinG}" step="0.01" class="form-control">
					</div>
					<div class="col">
						<label>è„‚è³ªï¼š</label>
						<input type="number" th:field="*{fatG}" step="0.01" class="form-control">
					</div>
					<div class="col">
						<label>ç‚­æ°´åŒ–ç‰©ï¼š</label>
						<input type="number" th:field="*{carbohydrateG}" step="0.01" class="form-control">
					</div>
				</div>
				<div class="row mt-2">
					<div class="col">
						<label>é£Ÿç‰©ç¹Šç¶­ï¼š</label>
						<input type="number" th:field="*{fiberG}" step="0.01" class="form-control">
					</div>
					<div class="col">
						<label>å¡©åˆ†ï¼š</label>
						<input type="number" th:field="*{saltG}" step="0.01" class="form-control">
					</div>
					<div class="col">
						<label>ã‚³ãƒ¬ã‚¹ãƒ†ãƒ­ãƒ¼ãƒ«ï¼š</label>
						<input type="number" th:field="*{cholesterolMg}" step="0.01" class="form-control">
					</div>
				</div>
			</div>
		</div>
		</div>

	</form>

	<div class="container">

		<div class="mt-5 mb-3">
			<h4 class="d-inline">ä½¿ç”¨é£Ÿæä¸€è¦§</h4>
			<button type="button" class="btn btn-warning" onclick="recalculateNutrition()">
				ğŸ”¢ æ „é¤Šå†è¨ˆç®—
			</button>
			<button class="btn btn-success" onclick="addIngredientRow()">
				ï¼‹ é£Ÿæè¿½åŠ 
			</button>

			<button type="button" class="btn btn-secondary" onclick="reloadIngredientsFromDB()">
				ğŸ”„ é£ŸæDBèª­è¾¼
			</button>
			<button type="button" class="btn btn-primary" onclick="submitIngredients()">
				ğŸ’¾ é£ŸæDBåæ˜ 
			</button>
			<button type="button" class="btn btn-warning" onclick="applyToMealPost()">
				é£Ÿäº‹æŠ•ç¨¿ã«åæ˜ 
			</button>
			<div class="d-flex align-items-center gap-2 mt-2">
				<input type="text" id="foodFilterInput" class="form-control w-25" placeholder="é£Ÿæãƒ•ã‚£ãƒ«ã‚¿ (ä¾‹: ãã°)">
				<label>
					<input type="checkbox" id="foodFilterEnable" checked>
					ãƒ•ã‚£ãƒ«ã‚¿åæ˜ 
				</label>
			</div>
		</div>


		<h4>é£Ÿæä¸€è¦§</h4>

		<table class="table table-bordered">
			<thead>
				<tr>
					<th>#</th>
					<th>é£Ÿæå</th>
					<th>ä½¿ç”¨é‡ (g)</th>
					<th>ã‚«ãƒ­ãƒªãƒ¼</th>
					<th>ãŸã‚“ã±ãè³ª</th>
					<th>è„‚è³ª</th>
					<th>ç‚­æ°´åŒ–ç‰©</th>
					<th>é£Ÿç‰©ç¹Šç¶­</th>
					<th>å¡©åˆ†</th>
					<th>ã‚³ãƒ¬ã‚¹ãƒ†ãƒ­ãƒ¼ãƒ«</th>
					<th>æ“ä½œ</th>
				</tr>
			</thead>
			<tbody id="ingredientTable">
				<!-- JSã§è¿½åŠ ã•ã‚Œã‚‹è¡Œã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¾‹ -->
			</tbody>
			<tfoot>
				<tr id="ingredientTotalRow">
					<!-- åˆè¨ˆãŒã“ã“ã«å…¥ã‚‹ -->
				</tr>
			</tfoot>
		</table>



		<p class="mt-4">
			<a class="btn btn-secondary" th:href="@{/mealposts}">â† ä¿å­˜ã—ãªã„ã§æˆ»ã‚‹</a>
		</p>

		<h4 class="mt-5"><a href="https://www.city.osaka.lg.jp/kenko/page/0000506951.html">å¤§é˜ªåºœ æ—¥æœ¬é£Ÿå“æ¨™æº–æˆåˆ†è¡¨</a></h4>
		<table class="table table-bordered table-sm" id="nutritionFoodsTable">
			<thead>
				<tr>
					<th>ID</th>
					<th>é£Ÿå“å</th>
					<th>ç¾¤</th>
					<th>ã‚«ãƒ­ãƒªãƒ¼</th>
					<th>ãŸã‚“ã±ãè³ª</th>
					<th>è„‚è³ª</th>
					<th>ç‚­æ°´åŒ–ç‰©</th>
					<th>é£Ÿç‰©ç¹Šç¶­</th>
					<th>å¡©åˆ†</th>
					<th>ã‚³ãƒ¬ã‚¹ãƒ†ãƒ­ãƒ¼ãƒ«</th>
				</tr>
			</thead>
			<tbody id="nutritionFoodsBody">
				<!-- JavaScriptã§æç”»ã™ã‚‹ã®ã§ä¸­èº«ã¯åˆæœŸç©ºã§OK -->
			</tbody>
		</table>
	</div>

	<div id="paginationControls" class="mt-3 d-flex justify-content-center"></div>

	</div>
	<script th:src="@{/js/bootstrap.bundle.min.js}"></script>

	<!-- å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
	<div class="modal fade" id="confirm-modal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title">å‰Šé™¤ç¢ºèª</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é–‰ã˜ã‚‹"></button>
				</div>
				<div class="modal-body">
					ã€Œ<span id="delete-name"></span>ã€ã®é£Ÿäº‹æŠ•ç¨¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ
				</div>
				<div class="modal-footer">
					<a class="btn btn-danger" id="delete-yes">ã¯ã„</a>
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã„ã„ãˆ</button>
				</div>
			</div>
		</div>
	</div>


	<script>
		let ingredientCounter = 0;
		const nutritionFoods = /*[[${nutritionFoods}]]*/ null || [];
		const ingredients = /*[[${ingredients}]]*/ null || [];

		document.querySelectorAll(".delete").forEach(btn =>
			btn.addEventListener("click", e => {
				const name = e.target.getAttribute("data-name");
				document.getElementById("delete-name").textContent = name;
				const href = e.target.getAttribute("data-href");
				document.getElementById("delete-yes").setAttribute("href", href);
			})
		);

		function previewImage(event) {
			const reader = new FileReader();
			reader.onload = function () {
				const preview = document.getElementById('preview');
				preview.src = reader.result;
			};
			reader.readAsDataURL(event.target.files[0]);
		}

		function previewImage(event) {
			const file = event.target.files[0];
			if (!file) return;

			const reader = new FileReader();
			reader.onload = function () {
				const preview = document.getElementById("preview");
				const container = document.getElementById("preview-container");

				preview.src = reader.result;
				preview.style.display = "block";      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã‚’è¡¨ç¤º
				container.style.display = "block";    // ãƒ©ãƒ™ãƒ«ã¨æ ã‚’è¡¨ç¤º
			};
			reader.readAsDataURL(file);
		}

		// æ „é¤Šæƒ…å ±å–å¾—
		function getNutritionById(id) {
			return nutritionFoods.find(f => f.id === Number(id));
		}

		function getFoodOptions(selectedId) {
			return nutritionFoods.map(food =>
				`<option value="${food.id}" ${food.id === selectedId ? 'selected' : ''}>${food.foodName}</option>`
			).join("");
		}


		function addIngredientRow(ingredient = {}) {
			const table = document.getElementById("ingredientTable");
			const row = document.createElement("tr");

			row.innerHTML = `
    <td>${++ingredientCounter}</td>
    <td>
      <select name="nutritionFoodIds" class="form-select">
        ${getFoodOptions(ingredient.nutritionFoodId)}
      </select>
    </td>
    <td>
      <input type="number" name="amountGrams" class="form-control" value="${ingredient.amountGrams || 0}" min="0" step="1" />
    </td>
    <td class="calories">0.0</td>
    <td class="protein">0.0</td>
    <td class="fat">0.0</td>
    <td class="carbs">0.0</td>
    <td class="fiber">0.0</td>
    <td class="salt">0.00</td>
    <td class="cholesterol">0.0</td>
    <td>
      <button type="button" class="btn btn-danger btn-sm" onclick="confirmAndRemoveRow(this)">å‰Šé™¤</button>
    </td>
  `;

			const totalRow = document.getElementById("totalRow");
			if (totalRow) {
				table.insertBefore(row, totalRow); // åˆè¨ˆè¡Œã®ç›´å‰ã«è¿½åŠ 
			} else {
				table.appendChild(row); // åˆè¨ˆè¡ŒãŒãªã‘ã‚Œã°æœ«å°¾ã«è¿½åŠ 
			}
		}

		function getFoodOptions(selectedId = null) {
			const filterText = document.getElementById("foodFilterInput")?.value?.toLowerCase() || "";
			const isFilterEnabled = document.getElementById("foodFilterEnable")?.checked;

			return window.nutritionFoods
				.filter(food => {
					if (!isFilterEnabled || !filterText) return true;
					return food.foodName.toLowerCase().includes(filterText);
				})
				.map(food => {
					const selected = food.id === selectedId || food.foodCode === selectedId ? 'selected' : '';
					return `<option value="${food.id}" ${selected}>${food.foodName}</option>`;
				})
				.join("");
		}

		// ğŸ”„ ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å†æç”»å‡¦ç†
		function refreshDropdowns() {
			const selects = document.querySelectorAll('select[name="nutritionFoodIds"]');
			selects.forEach(select => {
				const currentValue = parseInt(select.value);
				select.innerHTML = getFoodOptions(currentValue); // ãƒ•ã‚£ãƒ«ã‚¿ã‚’å†é©ç”¨
			});
		}

		// ğŸ§  å…¥åŠ›ãƒ•ã‚£ãƒ«ã‚¿ or ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´ã§ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
		document.getElementById("foodFilterInput")?.addEventListener("input", refreshDropdowns);
		document.getElementById("foodFilterEnable")?.addEventListener("change", refreshDropdowns);

		// å‰Šé™¤ç¢ºèª â†’ è¡Œå‰Šé™¤
		function confirmAndRemoveRow(button) {
			const ok = confirm("ã“ã®é£Ÿæè¡Œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ");
			if (ok) {
				const row = button.closest('tr');
				row.remove();
			}
		}

		// DBã‹ã‚‰å†èª­ã¿è¾¼ã¿ï¼ˆåˆæœŸã¾ãŸã¯æ›´æ–°å¾Œï¼‰
		function reloadIngredientsFromDB() {
			const table = document.getElementById("ingredientTableBody");
			table.innerHTML = '';
			ingredientCounter = 0;
			ingredients.forEach(addIngredientRow);
		}

		// åˆå›è¡¨ç¤º
		window.addEventListener("DOMContentLoaded", () => {
			reloadIngredientsFromDB();
		});
	</script>

	<!-- é£Ÿæä¸€è¦§ã®æ›´æ–°ã€å–å¾— -->
	<script th:inline="javascript">
		function submitIngredients() {
			const postId = /*[[${mealPost.id}]]*/ 0;

			const rows = Array.from(document.querySelectorAll('#ingredientTable tr'))
				.filter(row => row.querySelector('select')); // åˆè¨ˆè¡Œã‚’é™¤ã

			const ingredients = rows.map(row => {
				const nutritionFoodId = parseInt(row.querySelector('select').value);
				const amountGrams = parseFloat(row.querySelector('input[name="amountGrams"]').value);

				return {
					mealPostId: postId,
					nutritionFoodId,
					amountGrams
				};
			});

			console.log("ğŸ”„ é€ä¿¡ãƒ‡ãƒ¼ã‚¿:", ingredients);

			fetch("/mealPosts/updateIngredients", {
				method: "POST",
				headers: {
					"Content-Type": "application/json"
				},
				body: JSON.stringify(ingredients)
			})
				.then(response => {
					if (!response.ok) throw new Error("ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼");
					return response.text();
				})
				.then(message => {
					alert("âœ… é£Ÿææƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
					console.log("ğŸ“¦ ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹:", message);
				})
				.catch(err => {
					console.error("âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ", err);
					alert("âš ï¸ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
				});
		}
	</script>
	<script th:inline="javascript">
		const mealPostId = /*[[${mealPost.id}]]*/ 0;

		function reloadIngredientsFromDB() {
			if (!mealPostId || mealPostId === 0) {
				console.log("âš ï¸ æ–°è¦ä½œæˆä¸­ã®ãŸã‚ã€DBèª­ã¿è¾¼ã¿ã‚¹ã‚­ãƒƒãƒ—");
				return;
			}

			fetch(`/mealPosts/${mealPostId}/ingredients`)
				.then(res => res.json())
				.then(data => {
					const table = document.getElementById("ingredientTable");
					table.innerHTML = "";
					ingredientCounter = 0;

					// è¿½åŠ  â†’ æ „é¤Šè¨ˆç®—ã®ãŸã‚ä¸€æ™‚çš„ã«åˆè¨ˆç”¨ã«é›†è¨ˆ
					let total = {
						grams: 0,
						calories: 0,
						protein: 0,
						fat: 0,
						carbs: 0,
						fiber: 0,
						salt: 0,
						cholesterol: 0
					};

					data.forEach(ing => {
						addIngredientRow(ing);

						const food = window.nutritionFoods.find(f => f.id === ing.nutritionFoodId || f.foodCode === ing.nutritionFoodId);
						if (food) {
							const ratio = ing.amountGrams / 100;
							total.grams += ing.amountGrams;
							total.calories += food.energyKcal * ratio;
							total.protein += food.proteinG * ratio;
							total.fat += food.fatG * ratio;
							total.carbs += food.carbohydrateG * ratio;
							total.fiber += food.fiberG * ratio;
							total.salt += food.saltG * ratio;
							total.cholesterol += food.cholesterolMg * ratio;
						}
					});

					// æ „é¤Šå†è¨ˆç®—ã‚’å®Ÿè¡Œã—ã¦ã€å„è¡Œã®ã‚»ãƒ«ã«æ•°å€¤ã‚’å…¥ã‚Œã‚‹
					recalculateNutrition();

					// åˆè¨ˆè¡Œã‚’è¿½åŠ 
					appendTotalRow(total);
					console.log("âœ… DBèª­ã¿è¾¼ã¿å¾Œã«åˆè¨ˆè¡Œã‚’è¿½åŠ ã—ã¾ã—ãŸ", total);
				})
				.catch(err => {
					console.error("âŒ DBèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", err);
					alert("DBèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
				});
		}
	</script>

	<script th:inline="javascript">
		window.nutritionFoods = /*[[${nutritionFoods}]]*/[];
	</script>
	<script>
		function getFoodOptions(selectedId) {
			const filterEnabled = document.getElementById("foodFilterEnable")?.checked;
			const filterText = document.getElementById("foodFilterInput")?.value?.toLowerCase() || "";

			// ãƒ•ã‚£ãƒ«ã‚¿ã•ã‚ŒãŸãƒªã‚¹ãƒˆ
			let filtered = window.nutritionFoods;

			if (filterEnabled && filterText) {
				filtered = filtered.filter(food => food.foodName.toLowerCase().includes(filterText));
			}

			// âœ… ã‚‚ã—é¸æŠæ¸ˆã¿ãŒãƒ•ã‚£ãƒ«ã‚¿å¯¾è±¡ã«å«ã¾ã‚Œã¦ã„ãªã‹ã£ãŸã‚‰ã€å¼·åˆ¶çš„ã«è¿½åŠ 
			const selectedFood = window.nutritionFoods.find(f => f.id === selectedId);
			if (selectedFood && !filtered.some(f => f.id === selectedId)) {
				filtered = [selectedFood, ...filtered];
			}

			return filtered.map(food => `
    <option value="${food.id}" ${food.id === selectedId ? "selected" : ""}>
      ${food.foodName}
    </option>
  `).join("");
		}

		function recalculateNutrition() {
			if (!window.nutritionFoods || !Array.isArray(window.nutritionFoods)) {
				console.error("âŒ nutritionFoods ãŒå®šç¾©ã•ã‚Œã¦ã„ãªã„ã€ã¾ãŸã¯é…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“");
				return;
			}

			const tableRows = document.querySelectorAll("#ingredientTable tr");

			// åˆè¨ˆå€¤åˆæœŸåŒ–
			let totalGrams = 0;
			let totalCalories = 0;
			let totalProtein = 0;
			let totalFat = 0;
			let totalCarbs = 0;
			let totalFiber = 0;
			let totalSalt = 0;
			let totalCholesterol = 0;

			tableRows.forEach((row, index) => {
				const select = row.querySelector('select[name="nutritionFoodIds"]');
				const input = row.querySelector('input[name="amountGrams"]');

				if (!select || !input) return;

				const foodId = parseInt(select.value);
				const grams = parseFloat(input.value);

				if (!Number.isFinite(grams)) return;

				const food = window.nutritionFoods.find(f => f.id === foodId); // f.id === foodId || f.foodCode === foodId
				if (!food) return;

				const ratio = grams / 100;

				// æ „é¤Šç´ ã‚’è¡¨ç¤º
				row.querySelector('.calories').textContent = (food.energyKcal * ratio).toFixed(1);
				row.querySelector('.protein').textContent = (food.proteinG * ratio).toFixed(1);
				row.querySelector('.fat').textContent = (food.fatG * ratio).toFixed(1);
				row.querySelector('.carbs').textContent = (food.carbohydrateG * ratio).toFixed(1);
				row.querySelector('.fiber').textContent = (food.fiberG * ratio).toFixed(1);
				row.querySelector('.salt').textContent = (food.saltG * ratio).toFixed(2);
				row.querySelector('.cholesterol').textContent = (food.cholesterolMg * ratio).toFixed(1);

				// åˆè¨ˆã«åŠ ç®—
				totalGrams += grams;
				totalCalories += food.energyKcal * ratio;
				totalProtein += food.proteinG * ratio;
				totalFat += food.fatG * ratio;
				totalCarbs += food.carbohydrateG * ratio;
				totalFiber += food.fiberG * ratio;
				totalSalt += food.saltG * ratio;
				totalCholesterol += food.cholesterolMg * ratio;
			});

			appendTotalRow({
				grams: totalGrams,
				calories: totalCalories,
				protein: totalProtein,
				fat: totalFat,
				carbs: totalCarbs,
				fiber: totalFiber,
				salt: totalSalt,
				cholesterol: totalCholesterol
			});
		}

		function appendTotalRow({
			grams, calories, protein, fat, carbs, fiber, salt, cholesterol
		}) {
			const oldRow = document.getElementById("totalRow");
			if (oldRow) oldRow.remove();

			const tbody = document.getElementById("ingredientTable");

			const tr = document.createElement("tr");
			tr.id = "totalRow";
			tr.style.backgroundColor = "#f0f0f0";
			tr.style.fontWeight = "bold";
			tr.innerHTML = `
    <td colspan="2" class="text-end">åˆè¨ˆ</td>
    <td class="grams">${grams.toFixed(1)} g</td>
    <td class="calories">${calories.toFixed(1)}</td>
    <td class="protein">${protein.toFixed(1)}</td>
    <td class="fat">${fat.toFixed(1)}</td>
    <td class="carbs">${carbs.toFixed(1)}</td>
    <td class="fiber">${fiber.toFixed(1)}</td>
    <td class="salt">${salt.toFixed(2)}</td>
    <td class="cholesterol">${cholesterol.toFixed(1)}</td>
    <td></td>
  `;
			tbody.appendChild(tr);
		}

		function applyToMealPost() {
			const totalRow = document.getElementById("totalRow");
			if (!totalRow) {
				alert("âš ï¸ åˆè¨ˆè¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ã€å†è¨ˆç®—ã€ã—ã¦ãã ã•ã„ã€‚");
				return;
			}

			const getCellValue = (className) => {
				const cell = totalRow.querySelector(`.${className}`);
				if (!cell) {
					console.warn(`âš ï¸ ã‚»ãƒ« .${className} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
					return 0;
				}
				const value = parseFloat(cell.textContent);
				console.log(`ğŸ“¦ ${className} = ${value}`);
				return isNaN(value) ? 0 : value;
			};

			// åˆè¨ˆè¡Œã®å€¤å–å¾—
			const calorie = getCellValue("calories");
			const grams = getCellValue("grams");
			const protein = getCellValue("protein");
			const fat = getCellValue("fat");
			const carbs = getCellValue("carbs");
			const fiber = getCellValue("fiber");
			const salt = getCellValue("salt");
			const cholesterol = getCellValue("cholesterol");

			// å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ 
			document.querySelector('input[name="totalCalorie"]').value = calorie;
			document.querySelector('input[name="totalGrams"]').value = grams;
			document.querySelector('input[name="proteinG"]').value = protein;
			document.querySelector('input[name="fatG"]').value = fat;
			document.querySelector('input[name="carbohydrateG"]').value = carbs;
			document.querySelector('input[name="fiberG"]').value = fiber;
			document.querySelector('input[name="saltG"]').value = salt;
			document.querySelector('input[name="cholesterolMg"]').value = cholesterol;
		}

		//æ „é¤Šä¾¡ä¸€è¦§ã®ãƒ•ã‚£ãƒ«è¡¨ç¤ºå‡¦ç†
		function renderNutritionFoodsTable(filterText = "") {
			const tbody = document.getElementById("nutritionFoodsBody");
			tbody.innerHTML = ""; // ä¸€åº¦ã‚¯ãƒªã‚¢

			const filtered = window.nutritionFoods.filter(food =>
				food.foodName.includes(filterText)
			);

			filtered.forEach(food => {
				const tr = document.createElement("tr");
				tr.innerHTML = `
				<td>${food.id}</td>
				<td>${food.foodName}</td>
				<td>${food.groupName}</td>
				<td>${food.energyKcal}</td>
				<td>${food.proteinG}</td>
				<td>${food.fatG}</td>
				<td>${food.carbohydrateG}</td>
				<td>${food.fiberG}</td>
				<td>${food.saltG}</td>
				<td>${food.cholesterolMg}</td>
			`;
				tbody.appendChild(tr);
			});
		}

		document.getElementById("foodFilterInput").addEventListener("input", e => {
			const keyword = e.target.value.trim();
			renderNutritionFoodsTable(keyword);
		});
		renderNutritionFoodsTable(""); 
	</script>

	<!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæŒ‡å®šä»¶æ•°ã‚’è¶…ãˆã‚‹å ´åˆã¯ãƒšãƒ¼ã‚¸ç•ªå·ã‚’è¡¨ç¤ºã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ï¼‰ -->
	<script>
		const itemsPerPage = 40; // 1ãƒšãƒ¼ã‚¸ã®è¡¨ç¤ºä»¶æ•°
		const pageRangeAround = 3;      // ç¾åœ¨ãƒšãƒ¼ã‚¸ã®å‰å¾Œã«è¡¨ç¤ºã™ã‚‹ãƒšãƒ¼ã‚¸æ•°
		let currentPage = 1; // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸

		function renderNutritionFoodsPage(filterText = "", page = 1) {
			const tbody = document.getElementById("nutritionFoodsBody");
			tbody.innerHTML = "";

			const filtered = window.nutritionFoods.filter(food =>
				food.foodName.includes(filterText)
			);

			const totalPages = Math.ceil(filtered.length / itemsPerPage);
			currentPage = Math.min(Math.max(1, page), totalPages); // å®‰å…¨ãƒã‚§ãƒƒã‚¯

			const startIndex = (currentPage - 1) * itemsPerPage;
			const paginatedFoods = filtered.slice(startIndex, startIndex + itemsPerPage);

			paginatedFoods.forEach(food => {
				const tr = document.createElement("tr");
				tr.innerHTML = `
				<td>${food.id}</td>
				<td>${food.foodName}</td>
				<td>${food.groupName}</td>
				<td>${food.energyKcal}</td>
				<td>${food.proteinG}</td>
				<td>${food.fatG}</td>
				<td>${food.carbohydrateG}</td>
				<td>${food.fiberG}</td>
				<td>${food.saltG}</td>
				<td>${food.cholesterolMg}</td>
			`;
				tbody.appendChild(tr);
			});

			renderPaginationControls(totalPages, filterText);
		}

		function renderPaginationControls(totalPages, filterText) {
			const container = document.getElementById("paginationControls");
			container.innerHTML = "";

			if (totalPages <= 1) return;

			const ul = document.createElement("ul");
			ul.className = "pagination";

			// Â« å‰ã¸
			ul.appendChild(createPageButton("Â«", currentPage > 1, () => {
				renderNutritionFoodsPage(filterText, currentPage - 1);
			}));

			const addPage = (i, isActive = false) => {
				ul.appendChild(createPageButton(i, true, () => {
					renderNutritionFoodsPage(filterText, i);
				}, isActive));
			};

			// 1ãƒšãƒ¼ã‚¸ç›®ã¨çœç•¥è¨˜å·
			if (currentPage > 1 + pageRangeAround) {
				addPage(1);
				if (currentPage > 2 + pageRangeAround) {
					addEllipsis(ul);
				}
			}

			// ä¸­å¤®ã®å‰å¾Œãƒšãƒ¼ã‚¸
			for (let i = currentPage - pageRangeAround; i <= currentPage + pageRangeAround; i++) {
				if (i >= 1 && i <= totalPages) {
					addPage(i, i === currentPage);
				}
			}

			// æœ€å¾Œã®ãƒšãƒ¼ã‚¸ã¨çœç•¥è¨˜å·
			if (currentPage < totalPages - pageRangeAround) {
				if (currentPage < totalPages - pageRangeAround - 1) {
					addEllipsis(ul);
				}
				addPage(totalPages);
			}

			// Â» æ¬¡ã¸
			ul.appendChild(createPageButton("Â»", currentPage < totalPages, () => {
				renderNutritionFoodsPage(filterText, currentPage + 1);
			}));

			container.appendChild(ul);
		}

		function addEllipsis(ul) {
			const li = document.createElement("li");
			li.className = "page-item disabled";
			li.innerHTML = `<span class="page-link">â€¦</span>`;
			ul.appendChild(li);
		}

		function createPageButton(label, enabled, onClick, isActive = false) {
			const li = document.createElement("li");
			li.className = `page-item ${!enabled ? "disabled" : ""} ${isActive ? "active" : ""}`;

			const a = document.createElement("a");
			a.className = "page-link";
			a.href = "#";
			a.textContent = label;

			if (enabled) {
				a.addEventListener("click", e => {
					e.preventDefault();
					onClick();
				});
			}

			li.appendChild(a);
			return li;
		}

		// å…¥åŠ›ãƒ•ã‚£ãƒ«ã‚¿ã§å†æç”»ï¼ˆãƒšãƒ¼ã‚¸1ã«æˆ»ã™ï¼‰
		document.getElementById("foodFilterInput").addEventListener("input", e => {
			const keyword = e.target.value.trim();
			renderNutritionFoodsPage(keyword, 1);
		});

		// åˆæœŸè¡¨ç¤º
		window.addEventListener("DOMContentLoaded", () => {
			renderNutritionFoodsPage("", 1);
		});
	</script>
</body>

</html>