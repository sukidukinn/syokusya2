<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</title>
	<link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
	<style>
		body {
			padding: 20px;
		}

		:root {
			--health-box-width: 300px;
			--breakpoint: 600px;
			/* ğŸ‘ˆ â† ã“ã“ã§èª¿æ•´å¯èƒ½ã«ï¼ */
		}

		.sticky-health-box {
			position: sticky;
			top: 100px;
			width: var(--health-box-width);
			max-width: 100%;
			padding: 20px;
			background: #f8f9fa;
			border: 1px solid #ccc;
			border-radius: 8px;
		}

		@media screen and (max-width: 600px) {
			.sticky-health-box {
				position: static;
				width: 100%;
				margin-top: 20px;
			}

			.form-layout {
				flex-direction: column;
			}
		}

		.form-layout {
			display: flex;
			gap: 20px;
			align-items: flex-start;
		}

		.form-left {
			flex: 1;
		}
	</style>


</head>

<body>
	<h2>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</h2>


	<div class="row">
		<!-- å·¦å´ï¼šãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ•ã‚©ãƒ¼ãƒ  -->
		<div class="col-md-6">
			<form th:action="@{/profile/update}" th:object="${user}" method="post" id="profileForm">
				<div class="mb-3">
					<label>åå‰</label>
					<input type="text" class="form-control" th:field="*{name}">
					<div class="text-danger" th:errors="*{name}"></div>
				</div>
				<div class="mb-3">
					<label>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </label>
					<input type="text" class="form-control" th:field="*{nickname}">
				</div>
				<div class="mb-3">
					<label>å¹´é½¢</label>
					<input type="number" id="age" class="form-control" th:field="*{age}">
					<div class="text-danger" th:errors="*{age}"></div>
				</div>
				<div class="mb-3">
					<label>ä½æ‰€</label>
					<input type="text" class="form-control" th:field="*{address}">
				</div>
				<div class="mb-3">
					<label>æ€§åˆ¥</label>
					<select class="form-select" id="sex" th:field="*{sex}">
						<option value="0">ç”·æ€§</option>
						<option value="1">å¥³æ€§</option>
						<option value="2">ãã®ä»–</option>
					</select>
				</div>
				<div class="mb-3" hidden>
					<label>ä¼šå“¡ç¨®åˆ¥</label>
					<select class="form-select" th:field="*{typeId}">
						<option value="1">é€šå¸¸</option>
						<option value="2">ãƒ—ãƒ¬ãƒŸã‚¢ãƒ </option>
						<option value="3">é‹å–¶</option>
						<option value="4">è„±é€€</option>
					</select>
				</div>
				<div class="mb-3">
					<label>èº«é•· (cm)</label>
					<input type="number" class="form-control" id="heightCm" th:field="*{heightCm}">
				</div>
				<div class="mb-3">
					<label>ä½“é‡ (kg)</label>
					<input type="number" class="form-control" id="weightKg" th:field="*{weightKg}">
				</div>
				<div class="mb-3">
					<label>ç›®æ¨™ä½“é‡ (kg)</label>
					<input type="number" class="form-control" th:field="*{goalWeightKg}">
				</div>
				<div class="mb-3">
					<label>æ´»å‹•ãƒ¬ãƒ™ãƒ«ï¼ˆ1.0ã€œ2.5ï¼‰</label>
					<input type="number" step="0.01" class="form-control" id="activityLevel"
						th:field="*{activityLevel}">
				</div>
				<div class="mb-3">
					<label>è‡ªå·±ç´¹ä»‹</label>
					<textarea class="form-control" rows="3" th:field="*{bio}"></textarea>
				</div>
				<div class="mb-3">
					<label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
					<input type="email" class="form-control" th:field="*{email}">
					<div class="text-danger" th:errors="*{email}"></div>
				</div>
				<div class="mb-3">
					<label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
					<input type="password" class="form-control" th:field="*{password}">
				</div>

				<!-- ãƒ•ã‚©ãƒ¼ãƒ å†…ã«è¿½åŠ  -->
				<input type="hidden" name="bmi" id="bmiHidden" th:field="*{bmi}">
				<input type="hidden" name="bmr" id="bmrHidden" th:field="*{bmr}">
				<input type="hidden" name="tdee" id="tdeeHidden">
			</form>
		</div>

		<!-- å³å´ï¼šå¥åº·ãƒ‡ãƒ¼ã‚¿ï¼ˆè¿½å¾“ã•ã›ã‚‹ï¼‰ -->
		<div class="col-md-6">
			<div th:if="${pageMessage != null and !#strings.isEmpty(pageMessage)}" class="alert alert-success">
				[[${pageMessage}]]
			</div>

			<div class="sticky-health-box">
				<div>
					<button form="profileForm" type="submit" name="action" value="save"
						class="btn btn-primary">æ›´æ–°</button>
					<button form="profileForm" type="submit" name="action" value="saveAndBack"
						class="btn btn-success ms-2" hidden>ä¿å­˜ã—ã¦æˆ»ã‚‹</button>
					<a th:href="@{/mealPosts}" class="btn btn-secondary">æˆ»ã‚‹</a>
					<button type="button" class="btn btn-danger ms-2" onclick="confirmWithdrawal()">é€€ä¼š</button>
				</div>
				<hr>

				<h4>å¥åº·ãƒ‡ãƒ¼ã‚¿</h4>
				<li class="list-group-item">BMI: <span id="bmiDisplay" class="text-danger fw-bold">-</span></li>
				<li class="list-group-item">åŸºç¤ä»£è¬ (BMR): <span id="bmrDisplay" class="text-danger fw-bold">-</span>
					kcal</li>
				<li class="list-group-item">ç·æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼ (TDEE): <span id="tdeeDisplay" class="text-danger fw-bold">-</span>
					kcal</li>
				<li class="list-group-item">æ¨å¥¨ãŸã‚“ã±ãè³ª: <span id="proteinDisplay" class="text-danger fw-bold">-</span>
					g</li>
				<li class="list-group-item">æ¨å¥¨æ°´åˆ†é‡: <span id="waterDisplay" class="text-danger fw-bold">-</span> ml
				</li>
				<p class="text-muted small">
					â€» <a href="https://keisan.casio.jp/exec/system/1567491116" target="_blank"
						rel="noopener noreferrer">å¥åº·æŒ‡é‡</a>ã«åŸºã¥ãæ¨å®š
				</p>

				<hr>
				<h4>é£Ÿäº‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°åˆ¥ã®ç›®å®‰</h4>
				<li class="list-group-item">
					æœé£Ÿ(25%): <span id="calorieMorning" class="text-danger fw-bold">-</span> kcal /
					<span id="weightMorning" class="text-danger fw-bold">-</span> g
				</li>
				<li class="list-group-item">
					æ˜¼é£Ÿ(35%): <span id="calorieNoon" class="text-danger fw-bold">-</span> kcal /
					<span id="weightNoon" class="text-danger fw-bold">-</span> g
				</li>
				<li class="list-group-item">
					å¤•é£Ÿ(40%): <span id="calorieDinner" class="text-danger fw-bold">-</span> kcal /
					<span id="weightDinner" class="text-danger fw-bold">-</span> g
				</li>
				<p class="text-muted small">
					ç‰›ä¸¼: 495 kcal<br />ã‹ã‘ãã°: 371 kcal<br />ã”é£¯200g: 312 kcal<br />
					<a href="https://www.tanita.co.jp/magazine/column/4861/" target="_blank"
						rel="noopener noreferrer">æ‘‚å–ã‚«ãƒ­ãƒªãƒ¼æ—©è¦‹è¡¨</a>å‚ç…§
				</p>
			</div>
		</div>
	</div>

	<script>
		function confirmWithdrawal() {
			if (confirm("æœ¬å½“ã«é€€ä¼šã—ã¾ã™ã‹ï¼Ÿé€€ä¼šã™ã‚‹ã¨ãƒ­ã‚°ã‚¤ãƒ³ã§ããªããªã‚Šã¾ã™ã€‚")) {
				location.href = "/profile/withdraw";
			}
		}

		function updateHealthInfo() {
			const height = parseFloat(document.getElementById('heightCm')?.value) || 0;
			const weight = parseFloat(document.getElementById('weightKg')?.value) || 0;
			const age = parseInt(document.getElementById('age')?.value) || 0;
			const sex = parseInt(document.getElementById('sex')?.value); // 0: ç”·æ€§, 1: å¥³æ€§
			const activityLevel = parseFloat(document.getElementById('activityLevel')?.value) || 1.2;

			// BMIè¨ˆç®—
			const bmi = height > 0 ? (weight / ((height / 100) ** 2)) : 0;
			document.getElementById('bmiDisplay').textContent = bmi.toFixed(2);

			// ä»£è¬è¨ˆç®— ãƒãƒªã‚¹ãƒ»ãƒ™ãƒãƒ‡ã‚£ã‚¯ãƒˆæ–¹ç¨‹å¼(æ”¹è‰¯ç‰ˆ)
			let bmr = 0;
			if (!isNaN(sex)) {
				if (sex === 0) { // ç”·æ€§
					bmr = 13.397 * weight + 4.799 * height - 5.677 * age + 88.362;
				} else if (sex === 1) { // å¥³æ€§
					bmr = 9.247 * weight + 3.098 * height - 4.330 * age + 447.593;
				} else {
					// ãã®ä»–ã®å ´åˆã€ç”·å¥³å¹³å‡ã¨ã—ã¦ç”·æ€§å¼ã¨å¥³æ€§å¼ã®å¹³å‡ã‚’ä½¿ã†
					const maleBmr = 13.397 * weight + 4.799 * height - 5.677 * age + 88.362;
					const femaleBmr = 9.247 * weight + 3.098 * height - 4.330 * age + 447.593;
					bmr = (maleBmr + femaleBmr) / 2;
				}
				document.getElementById('bmrDisplay').textContent = bmr.toFixed(2);
			}

			// TDEEï¼ˆç·æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼ï¼‰
			const tdee = bmr * activityLevel;
			document.getElementById('tdeeDisplay').textContent = tdee.toFixed(2);

			// æ¨å¥¨ãŸã‚“ã±ãè³ªï¼ˆä¾‹ï¼šä½“é‡ Ã— 1.2gï¼‰
			const protein = weight * 1.2;
			document.getElementById('proteinDisplay').textContent = protein.toFixed(1);

			// æ¨å¥¨æ°´åˆ†é‡ï¼ˆä¾‹ï¼šä½“é‡ Ã— 35mlï¼‰
			const water = weight * 35;
			document.getElementById('waterDisplay').textContent = water.toFixed(0);

			// æœæ˜¼æ™©ã®æ¯”ç‡
			const morningRate = 0.25;
			const noonRate = 0.35;
			const nightRate = 0.40;

			// é£Ÿæã®1æ—¥æƒ³å®šé‡é‡ï¼ˆç›®å®‰ï¼‰ï¼šä½“é‡ Ã— 10gï¼ˆä¾‹: 60kg â†’ 600gï¼‰
			const totalWeight = weight * 10;

			// å„ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®ã‚«ãƒ­ãƒªãƒ¼ã¨é‡é‡ã‚’ç®—å‡º
			const morningCal = tdee * morningRate;
			const noonCal = tdee * noonRate;
			const nightCal = tdee * nightRate;

			const morningWeight = totalWeight * morningRate;
			const noonWeight = totalWeight * noonRate;
			const nightWeight = totalWeight * nightRate;

			// è¡¨ç¤ºæ›´æ–°
			document.getElementById('calorieMorning').textContent = morningCal.toFixed(0);
			document.getElementById('calorieNoon').textContent = noonCal.toFixed(0);
			document.getElementById('calorieDinner').textContent = nightCal.toFixed(0);

			document.getElementById('weightMorning').textContent = morningWeight.toFixed(0);
			document.getElementById('weightNoon').textContent = noonWeight.toFixed(0);
			document.getElementById('weightDinner').textContent = nightWeight.toFixed(0);

			//DBæ›´æ–°ç”¨ã®éè¡¨ç¤ºãƒ•ã‚©ãƒ¼ãƒ ã«è¨˜è¼‰
			document.getElementById('bmiHidden').value = bmi.toFixed(2);
			document.getElementById('bmrHidden').value = bmr.toFixed(2);
			document.getElementById('tdeeHidden').value = tdee.toFixed(2);
		}

		// å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã«ãƒã‚¤ãƒ³ãƒ‰
		window.addEventListener('DOMContentLoaded', () => {
			const inputsToWatch = ['age', 'sex', 'heightCm', 'weightKg', 'activityLevel'];
			inputsToWatch.forEach(id => {
				const el = document.getElementById(id);
				if (el) {
					el.addEventListener('input', updateHealthInfo);
					el.addEventListener('change', updateHealthInfo);
				}
			});

			updateHealthInfo(); // åˆæœŸæç”»ã‚‚å®Ÿè¡Œ
		});
	</script>

</body>

</html>