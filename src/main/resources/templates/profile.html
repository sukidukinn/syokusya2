<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</title>
	<link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
	<style>
		body {
			padding: 20px;
		}

		:root {
			--health-box-width: 300px;
			--breakpoint: 600px;
			/* ğŸ‘ˆ â† ã“ã“ã§èª¿æ•´å¯èƒ½ã«ï¼ */
		}

		.sticky-health-box {
			position: sticky;
			top: 100px;
			width: var(--health-box-width);
			max-width: 100%;
			padding: 20px;
			background: #f8f9fa;
			border: 1px solid #ccc;
			border-radius: 8px;
		}

		@media screen and (max-width: 600px) {
			.sticky-health-box {
				position: static;
				width: 100%;
				margin-top: 20px;
			}

			.form-layout {
				flex-direction: column;
			}
		}

		.form-layout {
			display: flex;
			gap: 20px;
			align-items: flex-start;
		}

		.form-left {
			flex: 1;
		}
	</style>


</head>

<body>
	<h2>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</h2>


	<div class="row">
		<!-- å·¦å´ï¼šãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ•ã‚©ãƒ¼ãƒ  -->
		<div class="col-md-6">
			<form th:action="@{/profile/update}" th:object="${user}" method="post" enctype="multipart/form-data"
				id="profileForm">
				<!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒè¡¨ç¤º -->
				<div class="mb-3">
					<label>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ</label><br>
					<img th:if="${user.photoPath != null}"
						th:src="@{'/uploads/' + ${#strings.substringAfter(user.photoPath, 'uploads/')}}"
						class="img-thumbnail mb-2" alt="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ" width="400" height="400">
					<span th:if="${user.photoPath == null}">ç”»åƒãªã—</span>
				</div>

				<!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
				<div class="mb-3">
					<label>ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼š</label>
					<input type="file" name="photoFile" class="form-control" onchange="previewImage(event)">
				</div>

				<!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
				<div class="mb-3" id="preview-container" style="display: none;">
					<label>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</label><br>
					<img id="preview" class="img-thumbnail" width="200" height="200" style="display: none;" />
				</div>

				<!-- ç”»åƒå‰Šé™¤ãƒœã‚¿ãƒ³ -->
				<div class="mb-3">
					<a th:href="@{/profile/clearImage}" class="btn btn-warning"
						onclick="return confirm('ç”»åƒã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ');">ç”»åƒã®ã¿å‰Šé™¤</a>
				</div>

				<div class="mb-3">
					<label>åå‰</label>
					<input type="text" class="form-control" th:field="*{name}">
					<div class="text-danger" th:errors="*{name}"></div>
				</div>
				<div class="mb-3">
					<label>ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </label>
					<input type="text" class="form-control" th:field="*{nickname}">
				</div>
				<div class="mb-3">
					<label>å¹´é½¢</label>
					<input type="number" id="age" class="form-control" th:field="*{age}">
					<div class="text-danger" th:errors="*{age}"></div>
				</div>
				<div class="mb-3">
					<label>ä½æ‰€</label>
					<input type="text" class="form-control" th:field="*{address}">
				</div>
				<div class="mb-3">
					<label>æ€§åˆ¥</label>
					<select class="form-select" id="sex" th:field="*{sex}">
						<option value="0">ç”·æ€§</option>
						<option value="1">å¥³æ€§</option>
						<option value="2">ãã®ä»–</option>
					</select>
				</div>
				<div class="mb-3" hidden>
					<label>ä¼šå“¡ç¨®åˆ¥</label>
					<select class="form-select" th:field="*{typeId}">
						<option value="1">é€šå¸¸</option>
						<option value="2">ãƒ—ãƒ¬ãƒŸã‚¢ãƒ </option>
						<option value="3">é‹å–¶</option>
						<option value="4">è„±é€€</option>
					</select>
				</div>
				<div class="mb-3">
					<label>èº«é•· (cm)</label>
					<input type="number" class="form-control" id="heightCm" th:field="*{heightCm}">
				</div>
				<div class="mb-3">
					<label>ä½“é‡ (kg)</label>
					<input type="number" class="form-control" id="weightKg" th:field="*{weightKg}">
				</div>
				<div class="mb-3">
					<label>ç›®æ¨™ä½“é‡ (kg)</label>
					<input type="number" class="form-control" th:field="*{goalWeightKg}">
				</div>
				<div class="mb-3">
					<label>æ´»å‹•ãƒ¬ãƒ™ãƒ«ï¼ˆ1.0ã€œ2.5ï¼‰</label>
					<input type="number" step="0.01" class="form-control" id="activityLevel"
						th:field="*{activityLevel}">
				</div>
				<div class="mb-3">
					<label>è‡ªå·±ç´¹ä»‹</label>
					<textarea class="form-control" rows="3" th:field="*{bio}"></textarea>
				</div>
				<div class="mb-3">
					<label>æ¸›é‡å¢—é‡é–‹å§‹æ—¥</label>
					<input type="date" class="form-control" name="startDate" th:field="*{startDate}">
				</div>

				<div class="mb-3">
					<label>ç›®æ¨™é”æˆã¾ã§ã®æ—¥æ•°</label>
					<input type="number" id="targetDays" class="form-control" th:field="*{targetDays}">
				</div>

				<div class="mb-3" hidden>
					<label>é€²æ—ç”»åƒï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åã¾ãŸã¯ãƒ‘ã‚¹ï¼‰</label>
					<input type="text" class="form-control" th:field="*{progressPhotoPath}">
				</div>
				<div class="mb-3">
					<label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
					<input type="email" class="form-control" th:field="*{email}">
					<div class="text-danger" th:errors="*{email}"></div>
				</div>
				<div class="mb-3">
					<label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
					<input type="password" class="form-control" th:field="*{password}">
				</div>

				<!-- ãƒ•ã‚©ãƒ¼ãƒ å†…ã«è¿½åŠ  -->
				<input type="hidden" th:field="*{bmi}" id="bmiHidden">
				<input type="hidden" th:field="*{bmr}" id="bmrHidden">
				<input type="hidden" th:field="*{tdee}" id="tdeeHidden">
				<input type="hidden" th:field="*{idealWeightKg}" id="idealWeightHidden">
				<input type="hidden" th:field="*{weightDiffKg}" id="weightDiffHidden">
				<input type="hidden" th:field="*{calorieGoal}" id="calorieGoalHidden">
			</form>
		</div>

		<!-- å³å´ï¼šå¥åº·ãƒ‡ãƒ¼ã‚¿ï¼ˆè¿½å¾“ã•ã›ã‚‹ï¼‰ -->
		<div class="col-md-6">
			<div th:if="${pageMessage != null and !#strings.isEmpty(pageMessage)}" class="alert alert-success">
				[[${pageMessage}]]
			</div>

			<div class="sticky-health-box">
				<div>
					<button form="profileForm" type="submit" name="action" value="save"
						class="btn btn-primary">æ›´æ–°</button>
					<button form="profileForm" type="submit" name="action" value="saveAndBack"
						class="btn btn-success ms-2" hidden>ä¿å­˜ã—ã¦æˆ»ã‚‹</button>
					<a th:href="@{/mealPosts}" class="btn btn-secondary">æˆ»ã‚‹</a>
					<button type="button" class="btn btn-danger ms-2" onclick="confirmWithdrawal()">é€€ä¼š</button>
				</div>
				<hr>

				<h4>å¥åº·ãƒ‡ãƒ¼ã‚¿</h4>
				<li class="list-group-item">BMI: <span id="bmiDisplay" class="text-danger fw-bold">-</span> (<span id="bmiLevel" class="text-danger fw-bold">æ™®é€š</span>)</li>
				<li class="list-group-item">BMR(åŸºç¤ä»£è¬é‡): <span id="bmrDisplay" class="text-danger fw-bold">-</span> kcal
				</li>
				<li class="list-group-item">TDEE(1æ—¥ã®ç·ç†±é‡): <span id="tdeeDisplay" class="text-danger fw-bold">-</span> kcal
				</li>
				<li class="list-group-item">ç†æƒ³ä½“é‡ (BMI22): <span id="idealWeight" class="text-danger fw-bold">-</span> kg
				</li>

				<li class="list-group-item">ç†æƒ³ã¨ã®å·®: <span id="weightDiffIdeal" class="text-danger fw-bold">-</span> kg
				</li>

				<li class="list-group-item">ç›®æ¨™ã¨ã®å·®: <span id="weightDiffGoal" class="text-danger fw-bold">-</span> kg
				</li>
				<li class="list-group-item">æ¸›é‡ã‚«ãƒ­ãƒªãƒ¼æ•°: <span id="totalCalorieDiff"
						class="text-danger fw-bold">-</span> kcal</li>
				<li class="list-group-item">1æ—¥ã‚ãŸã‚Šã®æ¶ˆè²»ãƒ»æ¸›é‡ã‚«ãƒ­ãƒªãƒ¼æ•°: <span id="dailyCalorieDiff" class="text-danger fw-bold">-</span>
					kcal</li>


				<hr>
				<h4>é£Ÿäº‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°åˆ¥ã®ç›®å®‰</h4>
				<li class="list-group-item">
					æœé£Ÿ(25%): <span id="calorieMorning" class="text-danger fw-bold">-</span> kcal /
					<span id="weightMorning" class="text-danger fw-bold">-</span> g
				</li>
				<li class="list-group-item">
					æ˜¼é£Ÿ(35%): <span id="calorieNoon" class="text-danger fw-bold">-</span> kcal /
					<span id="weightNoon" class="text-danger fw-bold">-</span> g
				</li>
				<li class="list-group-item">
					å¤•é£Ÿ(40%): <span id="calorieDinner" class="text-danger fw-bold">-</span> kcal /
					<span id="weightDinner" class="text-danger fw-bold">-</span> g
				</li>
				<p class="text-muted small">
					ç‰›ä¸¼: 495 kcal<br />ã‹ã‘ãã°: 371 kcal<br />ã”é£¯200g: 312 kcal<br />
					<a href="https://www.tanita.co.jp/magazine/column/4861/" target="_blank"
						rel="noopener noreferrer">æ‘‚å–ã‚«ãƒ­ãƒªãƒ¼æ—©è¦‹è¡¨</a>å‚ç…§
				</p>
			</div>
		</div>
	</div>

	<script>
		function confirmWithdrawal() {
			if (confirm("æœ¬å½“ã«é€€ä¼šã—ã¾ã™ã‹ï¼Ÿé€€ä¼šã™ã‚‹ã¨ãƒ­ã‚°ã‚¤ãƒ³ã§ããªããªã‚Šã¾ã™ã€‚")) {
				location.href = "/profile/withdraw";
			}
		}

		function updateHealthInfo() {
			const height = parseFloat(document.getElementById('heightCm')?.value) || 0;
			const weight = parseFloat(document.getElementById('weightKg')?.value) || 0;
			const age = parseInt(document.getElementById('age')?.value) || 0;
			const sex = parseInt(document.getElementById('sex')?.value); // 0: ç”·æ€§, 1: å¥³æ€§
			const goalWeight = parseFloat(document.querySelector('[name="goalWeightKg"]')?.value) || 0;
			const activityLevel = parseFloat(document.getElementById('activityLevel')?.value) || 1.2;
			const targetDays = parseInt(document.getElementById('targetDays')?.value) || 90;

			if (height <= 0 || weight <= 0 || isNaN(sex)) return;

			// BMIè¨ˆç®—
			const bmi = weight / ((height / 100) ** 2);
			document.getElementById('bmiDisplay').textContent = bmi.toFixed(2);
			const bmiHidden2 = document.getElementById('bmiHidden');
			if (bmiHidden2) bmiHidden.value = bmi.toFixed(2);

			// BMIæŒ‡æ¨™
			let bmiLevel = "";
			if (bmi < 18.5) bmiLevel = "ç—©ã›æ°—å‘³";
			else if (bmi < 25) bmiLevel = "æ¨™æº–";
			else if (bmi < 30) bmiLevel = "è‚¥æº€ï¼ˆ1åº¦ï¼‰";
			else if (bmi < 35) bmiLevel = "è‚¥æº€ï¼ˆ2åº¦ï¼‰";
			else bmiLevel = "è‚¥æº€ï¼ˆ3åº¦ä»¥ä¸Šï¼‰";
			document.getElementById('bmiLevel').textContent = bmiLevel;

			// åŸºç¤ä»£è¬ BMRï¼ˆãƒãƒªã‚¹ãƒ»ãƒ™ãƒãƒ‡ã‚£ã‚¯ãƒˆå¼ æ”¹è‰¯ç‰ˆï¼‰
			let bmr = 0;
			if (sex === 0) {
				bmr = 13.397 * weight + 4.799 * height - 5.677 * age + 88.362;
			} else if (sex === 1) {
				bmr = 9.247 * weight + 3.098 * height - 4.33 * age + 447.593;
			} else {
				bmr = (13.397 * weight + 4.799 * height - 5.677 * age + 88.362 + 9.247 * weight + 3.098 * height - 4.33 * age + 447.593) / 2;
			}
			document.getElementById('bmrDisplay').textContent = bmr.toFixed(2);
			const bmrHidden2 = document.getElementById('bmrHidden');
			if (bmrHidden2) bmrHidden.value = bmr.toFixed(2);

			// TDEE ç·æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼
			const tdee = bmr * activityLevel;
			document.getElementById('tdeeDisplay').textContent = tdee.toFixed(2);
			const tdeeHidden = document.getElementById('tdeeHidden');
			if (tdeeHidden) tdeeHidden.value = tdee.toFixed(2);

			// é£Ÿäº‹ãƒãƒ©ãƒ³ã‚¹(è¡¨ç¤ºã™ã‚‹ã ã‘ã®å‚è€ƒé …ç›®)
			const morningRate = 0.25, noonRate = 0.35, nightRate = 0.40;
			const totalWeight = weight * 10;
			const morningCal = tdee * morningRate;
			const noonCal = tdee * noonRate;
			const nightCal = tdee * nightRate;
			const morningWeight = totalWeight * morningRate;
			const noonWeight = totalWeight * noonRate;
			const nightWeight = totalWeight * nightRate;
			document.getElementById('calorieMorning').textContent = morningCal.toFixed(0);
			document.getElementById('calorieNoon').textContent = noonCal.toFixed(0);
			document.getElementById('calorieDinner').textContent = nightCal.toFixed(0);

			document.getElementById('weightMorning').textContent = morningWeight.toFixed(0);
			document.getElementById('weightNoon').textContent = noonWeight.toFixed(0);
			document.getElementById('weightDinner').textContent = nightWeight.toFixed(0);

			// ç†æƒ³ä½“é‡ï¼ˆBMI = 22ï¼‰
			const idealWeight = 22 * ((height / 100) ** 2);
			document.getElementById('idealWeight').textContent = idealWeight.toFixed(1);
			const idealWeightHidden = document.getElementById('idealWeightHidden');
			if (idealWeightHidden) idealWeightHidden.value = idealWeight.toFixed(1);

			// ç›®æ¨™ã¨ã®å·®
			const weightDiffGoal = weight - goalWeight;
			document.getElementById('weightDiffGoal').textContent = weightDiffGoal.toFixed(1);
			const weightDiffHidden = document.getElementById('weightDiffHidden');
			if (weightDiffHidden) weightDiffHidden.value = weightDiffGoal.toFixed(1);

			// ç·ã‚«ãƒ­ãƒªãƒ¼å·® = å·®åˆ†kg Ã— 7200kcal
			const totalCalorieDiff = weightDiffGoal * 7200;
			document.getElementById('totalCalorieDiff').textContent = totalCalorieDiff.toFixed(0);
			const dailyCalorieDiff = totalCalorieDiff / targetDays;
			document.getElementById('dailyCalorieDiff').textContent = dailyCalorieDiff.toFixed(0);

			// 1æ—¥ã‚ãŸã‚Šã®ã‚«ãƒ­ãƒªãƒ¼å·®
			document.getElementById('dailyCalorieDiff').textContent = dailyCalorieDiff.toFixed(0);
			const calorieGoalHidden = document.getElementById('calorieGoalHidden');
			if (calorieGoalHidden) calorieGoalHidden.value = dailyCalorieDiff.toFixed(0);
			// ç†æƒ³ã¨ã®å·®
			const weightDiffIdeal = weight - idealWeight;
			document.getElementById('weightDiffIdeal').textContent = weightDiffIdeal.toFixed(1);


			const calorieGoalHidden2 = document.getElementById('calorieGoalHidden');
			if (calorieGoalHidden2) calorieGoalHidden.value = dailyCalorieDiff.toFixed(0);
		}

		// å…¥åŠ›ã«åå¿œã—ã¦æ›´æ–°
		window.addEventListener('DOMContentLoaded', () => {
			const inputs = ['age', 'sex', 'heightCm', 'weightKg', 'activityLevel', 'goalWeightKg'];
			inputs.forEach(id => {
				const el = document.getElementById(id) || document.querySelector(`[name="${id}"]`);
				if (el) {
					el.addEventListener('input', updateHealthInfo);
					el.addEventListener('change', updateHealthInfo);
				}
			});
			updateHealthInfo(); // åˆæœŸæç”»æ™‚ã‚‚åæ˜ 
		});

		// å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã«ãƒã‚¤ãƒ³ãƒ‰
		window.addEventListener('DOMContentLoaded', () => {
			const inputsToWatch = ['age', 'sex', 'heightCm', 'weightKg', 'activityLevel'];
			inputsToWatch.forEach(id => {
				const el = document.getElementById(id);
				if (el) {
					el.addEventListener('input', updateHealthInfo);
					el.addEventListener('change', updateHealthInfo);
				}
			});

			updateHealthInfo(); // åˆæœŸæç”»ã‚‚å®Ÿè¡Œ
		});

		window.addEventListener('DOMContentLoaded', () => {
			updateHealthInfo();
		});
		function previewImage(event) {
			const file = event.target.files[0];
			if (!file) return;

			const reader = new FileReader();
			reader.onload = function (e) {
				const preview = document.getElementById("preview");
				const container = document.getElementById("preview-container");
				preview.src = e.target.result;
				preview.style.display = "block";
				container.style.display = "block";
			};
			reader.readAsDataURL(file);
		}
	</script>
</body>

</html>